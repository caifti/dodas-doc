<!doctype html><html lang="en" class="no-js"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="lang:clipboard.copy" content="Copy to clipboard"><meta name="lang:clipboard.copied" content="Copied to clipboard"><meta name="lang:search.language" content="en"><meta name="lang:search.pipeline.stopwords" content="True"><meta name="lang:search.pipeline.trimmer" content="True"><meta name="lang:search.result.none" content="No matching documents"><meta name="lang:search.result.one" content="1 matching document"><meta name="lang:search.result.other" content="# matching documents"><meta name="lang:search.tokenizer" content="[\s\-]+"><link rel="shortcut icon" href="../../assets/images/favicon.png"><meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.3.0"><title>HTCondor CMS Recipe - Dynamic On Demand Analysis Service</title><link rel="stylesheet" href="../../assets/stylesheets/application.4031d38b.css"><link rel="stylesheet" href="../../assets/stylesheets/application-palette.224b79ff.css"><meta name="theme-color" content=""><script src="../../assets/javascripts/modernizr.74668098.js"></script><link href="https://fonts.gstatic.com" rel="preconnect" crossorigin><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono&display=swap"><style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style><link rel="stylesheet" href="../../assets/fonts/material-icons.css"></head><body dir="ltr" data-md-color-primary="deep-blue" data-md-color-accent="orange"><svg class="md-svg"><defs></defs></svg> <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off"> <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off"> <label class="md-overlay" data-md-component="overlay" for="__drawer"></label><a href="#htcondor-cms-recipe" tabindex="1" class="md-skip">Skip to content </a><header class="md-header" data-md-component="header"><nav class="md-header-nav md-grid"><div class="md-flex"><div class="md-flex__cell md-flex__cell--shrink"><a href="../.." title="Dynamic On Demand Analysis Service" class="md-header-nav__button md-logo"><i class="md-icon"></i></a></div><div class="md-flex__cell md-flex__cell--shrink"><label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label></div><div class="md-flex__cell md-flex__cell--stretch"><div class="md-flex__ellipsis md-header-nav__title" data-md-component="title"><span class="md-header-nav__topic">Dynamic On Demand Analysis Service</span><span class="md-header-nav__topic">HTCondor CMS Recipe</span></div></div><div class="md-flex__cell md-flex__cell--shrink"><label class="md-icon md-icon--search md-header-nav__button" for="__search"></label><div class="md-search" data-md-component="search" role="dialog"><label class="md-search__overlay" for="__search"></label><div class="md-search__inner" role="search"><form class="md-search__form" name="search"><input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active"> <label class="md-icon md-search__icon" for="__search"></label> <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">&#xE5CD;</button></form><div class="md-search__output"><div class="md-search__scrollwrap" data-md-scrollfix><div class="md-search-result" data-md-component="result"><div class="md-search-result__meta">Type to start searching</div><ol class="md-search-result__list"></ol></div></div></div></div></div></div></div></nav></header><div class="md-container"><main class="md-main"><div class="md-main__inner md-grid" data-md-component="container"><div class="md-sidebar md-sidebar--primary" data-md-component="navigation"><div class="md-sidebar__scrollwrap"><div class="md-sidebar__inner"><nav class="md-nav md-nav--primary" data-md-level="0"><label class="md-nav__title md-nav__title--site" for="__drawer"><a href="../.." title="Dynamic On Demand Analysis Service" class="md-nav__button md-logo"><i class="md-icon"></i></a>Dynamic On Demand Analysis Service</label><ul class="md-nav__list" data-md-scrollfix><li class="md-nav__item"><a href="../.." title="Dynamic On Demand Analysis Service: DODAS" class="md-nav__link">Dynamic On Demand Analysis Service: DODAS</a></li><li class="md-nav__item"><a href="../../contacts/" title="Contact us" class="md-nav__link">Contact us</a></li><li class="md-nav__item"><a href="../../dodas-how-it-is-made/" title="DODAS: How it is made" class="md-nav__link">DODAS: How it is made</a></li><li class="md-nav__item"><a href="../../faq/" title="FAQ" class="md-nav__link">FAQ</a></li><li class="md-nav__item"><a href="../../introduction/" title="Introduction" class="md-nav__link">Introduction</a></li><li class="md-nav__item"><a href="../../known-issues/" title="Known Issues" class="md-nav__link">Known Issues</a></li><li class="md-nav__item"><a href="../../monitoring/" title="Monitoring" class="md-nav__link">Monitoring</a></li><li class="md-nav__item"><a href="../../the-enabling-facility/" title="The Enabling Facility" class="md-nav__link">The Enabling Facility</a></li><li class="md-nav__item"><a href="../../troubleshooting/" title="Troubleshooting" class="md-nav__link">Troubleshooting</a></li><li class="md-nav__item md-nav__item--active md-nav__item--nested"><input class="md-toggle md-nav__toggle" data-md-toggle="nav-10" type="checkbox" id="nav-10" checked><label class="md-nav__link" for="nav-10">Getting started</label><nav class="md-nav" data-md-component="collapsible" data-md-level="1"><label class="md-nav__title" for="nav-10">Getting started</label><ul class="md-nav__list" data-md-scrollfix><li class="md-nav__item"><a href="../" title="Getting Started" class="md-nav__link">Getting Started</a></li><li class="md-nav__item"><a href="../ams-recipe/" title="HTCondor AMS Recipe" class="md-nav__link">HTCondor AMS Recipe</a></li><li class="md-nav__item md-nav__item--active"><input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc"><label class="md-nav__link md-nav__link--active" for="__toc">HTCondor CMS Recipe</label><a href="./" title="HTCondor CMS Recipe" class="md-nav__link md-nav__link--active">HTCondor CMS Recipe</a><nav class="md-nav md-nav--secondary"><label class="md-nav__title" for="__toc">Table of contents</label><ul class="md-nav__list" data-md-scrollfix><li class="md-nav__item"><a href="#prerequisites" title="Prerequisites" class="md-nav__link">Prerequisites</a></li><li class="md-nav__item"><a href="#long-running-services" title="Long Running Services" class="md-nav__link">Long Running Services</a></li><li class="md-nav__item"><a href="#launching-a-dodas-instance-of-htcondor-for-cms" title="Launching a DODAS instance of HTCondor for CMS" class="md-nav__link">Launching a DODAS instance of HTCondor for CMS</a></li><li class="md-nav__item"><a href="#submitting-crab-jobs-for-dodas-cms-site" title="Submitting CRAB jobs for DODAS CMS Site" class="md-nav__link">Submitting CRAB jobs for DODAS CMS Site</a></li></ul></nav></li><li class="md-nav__item"><a href="../recipe-for-impatient-users/" title="Recipe for impatient users" class="md-nav__link">Recipe for impatient users</a></li></ul></nav></li><li class="md-nav__item md-nav__item--nested"><input class="md-toggle md-nav__toggle" data-md-toggle="nav-11" type="checkbox" id="nav-11"><label class="md-nav__link" for="nav-11">Using dodas with external providers</label><nav class="md-nav" data-md-component="collapsible" data-md-level="1"><label class="md-nav__title" for="nav-11">Using dodas with external providers</label><ul class="md-nav__list" data-md-scrollfix><li class="md-nav__item"><a href="../../using-dodas-with-external-providers/" title="Using DODAS with external providers" class="md-nav__link">Using DODAS with external providers</a></li><li class="md-nav__item"><a href="../../using-dodas-with-external-providers/how-to-use-a-public-cloud/" title="How to use a public IaaS with DODAS-PaaS" class="md-nav__link">How to use a public IaaS with DODAS-PaaS</a></li><li class="md-nav__item"><a href="../../using-dodas-with-external-providers/how-to-use-your-own-cloud/" title="How to use private IaaS with DODAS-PaaS" class="md-nav__link">How to use private IaaS with DODAS-PaaS</a></li></ul></nav></li></ul></nav></div></div></div><div class="md-sidebar md-sidebar--secondary" data-md-component="toc"><div class="md-sidebar__scrollwrap"><div class="md-sidebar__inner"><nav class="md-nav md-nav--secondary"><label class="md-nav__title" for="__toc">Table of contents</label><ul class="md-nav__list" data-md-scrollfix><li class="md-nav__item"><a href="#prerequisites" title="Prerequisites" class="md-nav__link">Prerequisites</a></li><li class="md-nav__item"><a href="#long-running-services" title="Long Running Services" class="md-nav__link">Long Running Services</a></li><li class="md-nav__item"><a href="#launching-a-dodas-instance-of-htcondor-for-cms" title="Launching a DODAS instance of HTCondor for CMS" class="md-nav__link">Launching a DODAS instance of HTCondor for CMS</a></li><li class="md-nav__item"><a href="#submitting-crab-jobs-for-dodas-cms-site" title="Submitting CRAB jobs for DODAS CMS Site" class="md-nav__link">Submitting CRAB jobs for DODAS CMS Site</a></li></ul></nav></div></div></div><div class="md-content"><article class="md-content__inner md-typeset"><h1 id="htcondor-cms-recipe">HTCondor CMS Recipe</h1>
<p>The DODAS workflow implemented for CMS has been designed in order to generate an ephemeral Tier* WLCG compliant. </p>
<h2 id="prerequisites">Prerequisites</h2>
<p>In the basic implementation has been built on the following assumptions </p>
<ol>
<li>There is <strong>no Computing Element</strong>. Worker nodes (HTCondor startd processes) start up as a docker container over Mesos cluster, and auto-join the HTCondor Global-Pool of CMS</li>
<li>Data I/O is meant to rely on AAA xrootd read rule </li>
<li>although there is not technical limitation preventing the usage of local storages.</li>
<li>stage-out relies on a Tier site of CMS, e.g. INFN relies on TI_IT_CNAF. The result is something like this in the site local config  </li>
</ol>
<p><code>text
   url="trivialcatalog_file:/cvmfs/cms.cern.ch/SITECONF/T1_IT_CNAF/PhEDEx/storage.xml?protocol=srmv2"/&gt;</code></p>
<p>This imply to accomplish with the following pre-requisites: </p>
<ul>
<li>Requires Submission Infrastructure (SI) L2s authorization for Global-Pool access. In order to being authorized you must belong to the CMS Collaboration and provide a DN and CMS Site Name. SI will use these info to define the proper mapping in the match-maker. </li>
<li>Get a DN from X.509 Certificate you can retrieve from the <a href="https://dodas-tts.cloud.cnaf.infn.it/">Token Translation Service </a>.  1. Click to request a x509.  2. A pop-up window will allow you to download the certificate PEM file. At that point you should run  <code>openssl x509 -noout -in &lt;certificate.pem&gt; -subject</code> 3. and you will obtain something like  <code>subject= /C=IT/O=CLOUD@CNAF/CN=xxxxxxx@dodas-iam</code></li>
<li>Define a name for your ephemeral CMS Site: e.g.  <code>T3_XX_Opportunistic_KK</code></li>
<li>If you want to be visible in the Dashboard (this is ONLY true for the old-fashioned <a href="http://dashboard.cern.ch/cms/">Dashboard</a>) you need to notify the dashboard support team informing that you need the following mapping among Site Name and SyncCE  <code>Site Name == T3_XX_Opportunistic_KK  SyncCE == T3_XX_Opportunistic_KK</code></li>
<li>NOTE : This is needed because DODAS does not deploy a cluster which relies on a Computing Element. </li>
<li>You need to provide a job id to the CERN monitoring team.</li>
</ul>
<h2 id="long-running-services">Long Running Services</h2>
<p>Once done all of this, you should be able to get this TOSCA template and configure everything as described in the template itself.<br />
The CMS template deploys the following services and components: <br />
- squid proxy<br />
- proxy cache <br />
- worker node (HTCondor startd)<br />
- cvmfs<br />
- cvmfs-check app  <br />
- CMS Trivial File Catalogue</p>
<p>Docker image files are available <a href="https://github.com/DODAS-TS">here</a>.</p>
<h2 id="launching-a-dodas-instance-of-htcondor-for-cms">Launching a DODAS instance of HTCondor for CMS</h2>
<p>This assume you are now familiar with following steps:</p>
<ol>
<li>how to GET a token from IAM-DODAS</li>
<li>how to submit a TOSCA template (either with PaaS orchestrator or Infrastructure Manager)</li>
</ol>
<p>You can get the basic CMS TOSCA template from <a href="https://github.com/indigo-dc/tosca-templates/blob/master/dodas/CMS-HTCondor-dodas.yaml">here</a> and submit it after a proper configuration. There input parameters to be set are explained below. THere are 3 sections and these are the mandatory parameters. For advanced usage there is more to be configured.   </p>
<ol>
<li><strong>Marathon and Mesos related configuration parameters</strong></li>
<li><strong>marathon_username</strong>: Admin username for Marathon GUI</li>
<li><strong>marathon_password</strong>: Admin password for for Marathon GUI</li>
<li><strong>mesos_username</strong>: Admin username for Mesos GUI</li>
<li><strong>mesos_password</strong>: Admin password for Mesos GUI</li>
<li><strong>number_of_masters</strong>: </li>
<li><strong>num_cpus_master</strong>: </li>
<li><strong>mem_size_master</strong>:</li>
<li><strong>number_of_slaves</strong>:</li>
<li><strong>num_cpus_slave</strong>:</li>
<li><strong>mem_size_slave:</strong></li>
<li><strong>number_of_lbs</strong>:</li>
<li><strong>num_cpus_lb</strong>: </li>
<li><strong>mem_size_lb</strong>:</li>
<li><strong>server_image</strong>: Image for the Virtual Machine to be used. NOTE all the recipes are validated for Ubuntu Xenial.  </li>
<li><strong>IAM related configurations to enable the OIDC to X.509 certificate translation</strong></li>
<li><strong>iam_token</strong>: The token string obtained as explained <a href="../recipe-for-impatient-users/#2-token-management">here</a></li>
<li><strong>Iam_client_id</strong>: This must be provided (once) by DODAS admins</li>
<li>
<p><strong>iam_client_secret</strong>: This must be provided (once) by DODAS admins</p>
</li>
<li>
<p><strong>CMS specific configurations</strong> </p>
</li>
<li><strong>cms_local_site</strong>: This is a name of the format T3_XX_Opportunistic_KK. You decide this as explained <a href="./#prerequisites">here</a>.</li>
<li><strong>cms_stageoutsite</strong>: This must be either an already existing T1/2/3, or a new site you will register in the CMS computing system.  </li>
<li><strong>cms_stageoutprotocol</strong>: this is the protocol you want to use, to be set accordingly with one of the options supported by the SITECONF related to the cms_stageoutsite. </li>
</ol>
<p>Once the cluster has been created you should be able to access the Marathon and Mesos GUIs for management, debugging etc.</p>
<p>The very last step of the deployment is the start-up HTCondor startd process. If no errors are encountered the startds should join the HTCondor global pool automatically, and thus if matching happens HTCondor start executing payloads. <br />
At that point, most probably, you would like to submit some jobs with proper configuration to allow the matching. </p>
<h2 id="submitting-crab-jobs-for-dodas-cms-site">Submitting CRAB jobs for DODAS CMS Site</h2>
<p>In order to submit CRAB jobs with proper classad parameters which guarantee the matching, you need to add this extra line in the configuration file of CRAB: </p>
<pre><code class="text">config.Debug.extraJDL = [ '+DESIRED_Sites=&quot;T3_XX_XY_KK&quot;','+JOB_CMSSite=&quot;T3_XX_XY_KK&quot;','+AccountingGroup=&quot;highprio.&lt;YOUR_LXPLUS_LOGIN&gt;&quot;' ]
</code></pre>

<p>There is no any other change you need to do. </p>
<p>Finally there is a basic Elastic Search monitoring system which can be used and extended to cope with user specific needs. This is detailed <a href="../../monitoring/#monitoring-implementation">here</a>.</p></article></div></div></main><footer class="md-footer"><div class="md-footer-nav"><nav class="md-footer-nav__inner md-grid"><a href="../ams-recipe/" title="HTCondor AMS Recipe" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev"><div class="md-flex__cell md-flex__cell--shrink"><i class="md-icon md-icon--arrow-back md-footer-nav__button"></i></div><div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"><span class="md-flex__ellipsis"><span class="md-footer-nav__direction">Previous</span>HTCondor AMS Recipe</span></div></a><a href="../recipe-for-impatient-users/" title="Recipe for impatient users" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next"><div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"><span class="md-flex__ellipsis"><span class="md-footer-nav__direction">Next</span>Recipe for impatient users</span></div><div class="md-flex__cell md-flex__cell--shrink"><i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i></div></a></nav></div><div class="md-footer-meta md-typeset"><div class="md-footer-meta__inner md-grid"><div class="md-footer-copyright">powered by <a href="https://www.mkdocs.org">MkDocs</a> and <a href="https://squidfunk.github.io/mkdocs-material/">Material for MkDocs</a></div></div></div></footer></div><script src="../../assets/javascripts/application.b260a35d.js"></script><script>app.initialize({version:"1.0.4",url:{base:"../.."}})</script></body></html>